# 修改记录

## 2026-01-22: 添加群成员时附加 Privacy Token

**文件**: `group.go`

**问题背景**:
使用 whatsmeow 原有的 `UpdateGroupParticipants` 方法添加群成员时容易被封号，原因是请求结构与 WhatsApp Web 不一致。

**修改内容**:
1. 添加 `PrivacyTokenExpireDuration` 常量（7天过期时间）
2. 添加 `IsPrivacyTokenExpired()` 函数检查 Token 是否过期
3. 修改 `UpdateGroupParticipants` 方法，在添加群成员时：
   - 获取参与者的 Privacy Token
   - 检查 Token 是否过期
   - 仅在 Token 有效时附加到请求中

**关键改动** (第 24-30 行新增):
```go
const PrivacyTokenExpireDuration = 7 * 24 * time.Hour

func IsPrivacyTokenExpired(timestamp time.Time) bool {
    return time.Since(timestamp) > PrivacyTokenExpireDuration
}
```

**UpdateGroupParticipants 新增逻辑** (第 204-220 行):
```go
// Attach valid privacy token when adding participants (mimics WhatsApp Web behavior)
if action == ParticipantChangeAdd {
    pt, err := cli.Store.PrivacyTokens.GetPrivacyToken(ctx, participantJID)
    if err != nil {
        cli.Log.Warnf("Failed to get privacy token for %s: %v", participantJID, err)
    } else if pt != nil {
        if !IsPrivacyTokenExpired(pt.Timestamp) {
            content[i].Content = []waBinary.Node{{
                Tag:     "privacy",
                Content: pt.Token,
            }}
        } else {
            cli.Log.Debugf("Privacy token expired for %s", participantJID)
        }
    }
}
```

**效果**: 模拟 WhatsApp Web 的行为，降低被封号风险。

---

## 2026-01-20: 添加 SkipOwnDevices 选项

**文件**: `send.go`, `internals.go`

**修改内容**:
- 在 `SendRequestExtra` 中添加 `SkipOwnDevices` 字段
- 设为 `true` 时，发送的消息不会同步到自己的其他设备

**用法**:
```go
cli.SendMessage(ctx, targetJID, message, whatsmeow.SendRequestExtra{
    SkipOwnDevices: true,
})
```

**注意**: 仅对私聊消息有效，群组消息使用 sender key 加密机制，无法跳过同步。

---

## 2026-01-20: 配对码改为纯数字格式

**文件**: `pair-code.go`

**修改内容**:
- 将配对码从 base32 编码（字母+数字混合）改为纯数字形式
- 之前格式: `ABCD-EFGH`（使用字符集 `123456789ABCDEFGHJKLMNPQRSTVWXYZ`）
- 现在格式: `1234-5678`（8位纯数字，范围 00000000-99999999）

**具体改动**:
1. 移除了 `encoding/base32` import
2. 移除了 `linkingBase32` 变量
3. 将 5 字节随机数转换为 8 位纯数字码（通过取模 100000000）
4. 返回格式保持 `XXXX-XXXX`，但现在全是数字
